# 3. 機能詳細

PCSS（Percentage Closer Soft Shadows）という距離に応じて影の柔らかさを変動させる仕組みをVRChatで使えるようにカスタマイズしたものです。

これにより、リアルタイムに高解像度な影を比較的低負荷で落とすことができ、前髪や、顎、胸といった様々な部位の影がつくことで、圧倒的な立体感・存在感が表現できます。

PCSSの実装としては、UnityアセットNext-Gen Soft-Shadows</br>
[https://assetstore.unity.com/packages/vfx/shaders/next-gen-soft-shadows-137380?locale=ja-JP](https://assetstore.unity.com/packages/vfx/shaders/next-gen-soft-shadows-137380?locale=ja-JP)</br>
または下記OSSを参考に作成したシェーダーを使用しています。</br>
[https://github.com/TheMasonX/UnityPCSS](https://github.com/TheMasonX/UnityPCSS)

- lilToonもしくはPoiyomiをPCSS用にカスタムしたカスタムシェーダーをアバターに組み込みます。

- 上記シェーダーはワールドのライトの影響を抑え、アバターにセットアップされたスポットライトの影響を支配的に受けるように設定されています。

- 上記にある通り、セットアップツールはアバターにスポットライトを組み込みます。

- スポットライトはHeadを照らすようになっています。

- スポットライトの向きはPhysBoneでコントロールすることができます。

- ライトの強さはExpressionMenuからコントロールすることができます。

- ライトの色もExpressionMenuからコントロールすることができます。Hueが色相、Saturationが彩度です。

- ワールドライトの色を、自身のライトの色に反映させることができます。</br>
（※カメラコンポーネントを使用しているため、他人視点からは、フレンドかAvatarDisplayしている場合にしか反映されません。）

- ExpressionMenuのRemoteShadowOnをオフにすると、他のプレイヤーの視点では影が映らなくなります。

- ExpressionMenuのLocalShadowOnをオフにすると、自分の視点では影が映らなくなります。

- マテリアルの「カスタムプロパティ」で、影の柔らかさ、濃さ、ワールドライトの影響度の調節、マスクの設定などが可能です。

- 一部のアバターで白目に瞳等の影が映りこんでしまうアバターがありますが、マスク機能を使うことで、影を落としたくない箇所をマスクできます。

- Unityの通常の仕様では、半透過オブジェクトは影がつきません。これを改善し、半透過と影を両立しました。</br>
（※RenderQueue2500以下が必須）

- 主にアニメ調向けに影の境界をくっきりさせるShadowClamp機能が追加されました。